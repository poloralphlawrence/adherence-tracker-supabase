<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Adherence Tracker with Roles</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Add Inter font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      font-family: 'Inter', Arial, Helvetica, sans-serif;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
    }
    .header-left {
      font-size: 14px;
      color: var(--text-color, #1C2127);
      padding-left: 2px;
    }
    .top-right-controls {
      font-size: 14px;
    }
    .top-right-controls a {
      color: inherit;
      text-decoration: none;
      margin-left: 10px;
      cursor: pointer;
    }
    .top-right-controls a:hover {
      text-decoration: underline;
    }
    .user-controls-wrapper {
      width: 33%;
      min-width: 280px;
      margin: 16px 0;
      margin-left: 25px;
    }
    .adherence-controls {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
      align-items: end;
    }
    .adherence-select select {
      width: 100%;
      box-sizing: border-box;
    }
    .adherence-button button {
      width: 100%;
      box-sizing: border-box;
      height: 42px;
    }
    .adherence-timer {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }
    .adherence-timer span {
      font-weight: 500;
      min-width: 80px;
      font-size: 15px;
      color: #3148F6;
      letter-spacing: 1px;
    }
    .user-table-header {
      width: 95%;
      max-width: 1200px;
      margin: 0 auto 10px auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-table-header h2 {
      flex: 1;
      text-align: center;
      margin: 0;
    }
    .filters-user {
      display: flex;
      justify-content: flex-end;
    }
    .filters-user label {
      display: flex;
      flex-direction: column;
      font-size: 14px;
    }
    .filters-user input[type="date"] {
      width: 170px;
      height: 42px;
      box-sizing: border-box;
      margin-top: 4px;
    }
    .filters-admin {
      display: grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr)) 160px;
      gap: 16px;
      align-items: end;
      justify-content: center;
      max-width: 1100px;
      margin: 8px auto 20px auto;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .filters-admin label {
      display: flex;
      flex-direction: column;
      font-size: 14px;
    }
    .filters-admin input,
    .filters-admin select {
      height: 42px;
      box-sizing: border-box;
      padding: 8px 10px;
    }
    .filters-admin .export-btn {
      display: flex;
      justify-content: flex-end;
      align-items: end;
    }
    .filters-admin .export-btn button {
      height: 42px;
      padding: 0 16px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      background: var(--primary, #3148F6);
      color: #fff;
      border: none;
    }
    .filters-admin .export-btn button:hover {
      background: var(--primary-hover, #1C4B8F);
    }
    .hidden { display: none; }
    .active-adherence-section {
      margin: 20px 0 30px 0;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
      background: #f7f8fa;
      border-radius: 8px;
      padding: 18px 12px 10px 12px;
      box-shadow: 0 1px 4px rgba(60,60,60,0.06);
    }
    .active-adherence-section h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 19px;
      color: #3148F6;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .active-adherence-section table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    }
    .active-adherence-section th, .active-adherence-section td {
      padding: 7px 8px;
      border-bottom: 1px solid #e2e6ee;
      text-align: left;
      font-size: 15px;
    }
    .active-adherence-section th {
      background: #eaf0ff;
      font-weight: 600;
      color: #3148F6;
    }
    .active-adherence-section td {
      color: #222;
    }
    .active-adherence-section .running-timer {
      font-family: 'Inter', monospace;
      font-weight: 600;
      color: #1C4B8F;
      letter-spacing: 1px;
    }
    @media (max-width: 900px) {
      .user-controls-wrapper {
        width: 90%;
        margin-left: auto;
        margin-right: auto;
      }
      .filters-admin {
        grid-template-columns: repeat(2, 1fr);
        grid-auto-rows: auto;
      }
      .filters-admin .export-btn {
        justify-content: flex-start;
        width: 100%;
      }
      .user-table-header {
        flex-direction: column;
        gap: 10px;
      }
      .user-table-header h2 {
        text-align: center;
      }
      .filters-user {
        justify-content: center;
      }
      .active-adherence-section {
        padding: 10px 2px 6px 2px;
      }
      .active-adherence-section th, .active-adherence-section td {
        font-size: 13px;
        padding: 5px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <span id="welcomeText" class="hidden">
        Welcome, <span id="currentUser"></span> (<span id="currentRole"></span>)
      </span>
    </div>
    <div class="top-right-controls">
      <a href="#" id="themeToggle">Dark Mode</a>   
      <a href="#" id="logoutLink" class="hidden">Log Out</a>
    </div>
  </div>
  <h1 style="margin-top:6px; text-align:center;">Adherence Tracker</h1>
  <div id="authSection" class="card">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" required />
    <input type="password" id="loginPassword" placeholder="Password" required />
    <button id="loginBtn">Login</button>
    <p style="text-align:center">or</p>
    <button id="signupBtn">Sign Up</button>
  </div>
  <div id="appSection" class="hidden">
    <div id="userView" class="hidden">
      <div class="user-controls-wrapper">
        <form id="adherenceForm" class="adherence-controls" onsubmit="return false;">
          <div class="adherence-select">
            <label for="adherenceType">Adherence Type</label>
            <select id="adherenceType" name="adherenceType" required>
              <option value="Online">Online</option>
              <option value="Offline">Offline</option>
              <option value="Bio Break">Bio Break</option>
              <option value="Break 1">Break 1</option>
              <option value="Break 2">Break 2</option>
              <option value="Lunch Break">Lunch Break</option>
              <option value="Meeting">Meeting</option>
              <option value="Adhoc Task">Adhoc Task</option>
              <option value="Training">Training</option>
            </select>
          </div>
          <div class="adherence-button">
            <label style="visibility:hidden">&nbsp;</label>
            <button type="button" id="startBtn">Start</button>
            <div class="adherence-timer hidden" id="adherenceTimerBox">
              <button type="button" id="stopBtn" style="margin-top:0;">Stop</button>
              <span id="runningTime">00:00:00</span>
            </div>
          </div>
        </form>
      </div>
      <div class="user-table-header">
        <h2>My Adherence Records</h2>
        <div class="filters-user">
          <label>
            Date
            <input type="date" id="userFilterDate">
          </label>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Adherence Type</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Duration (minutes)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div id="adminView" class="hidden">
      <h2 style="text-align:center">All Adherence Records</h2>
      <div id="activeAdherenceSection" class="active-adherence-section">
        <h3>Active Adherence Sessions</h3>
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Adherence Type</th>
              <th>Start Time</th>
              <th>Running Time</th>
            </tr>
          </thead>
          <tbody id="activeAdherenceBody"></tbody>
        </table>
      </div>
      <div class="filters-admin">
        <label>
          Date
          <input type="date" id="filterDate">
        </label>
        <label>
          User
          <input type="text" id="filterUser" placeholder="Enter user email">
        </label>
        <label>
          Adherence Type
          <select id="filterType">
            <option value="">All</option>
            <option value="Online">Online</option>
            <option value="Offline">Offline</option>
            <option value="Bio Break">Bio Break</option>
            <option value="Break 1">Break 1</option>
            <option value="Break 2">Break 2</option>
            <option value="Lunch Break">Lunch Break</option>
            <option value="Meeting">Meeting</option>
            <option value="Adhoc Task">Adhoc Task</option>
            <option value="Training">Training</option>
          </select>
        </label>
        <label>
          Timezone
          <select id="timezoneSelect">
            <option value="America/New_York">Eastern Time (EST)</option>
            <option value="America/Los_Angeles">Pacific Time (PST)</option>
            <option value="Asia/Manila" selected>Philippine Time (PHT)</option>
          </select>
        </label>
        <div class="export-btn">
          <button id="exportCsv">Export CSV</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Adherence Type</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Duration (minutes)</th>
          </tr>
        </thead>
        <tbody id="adminTableBody"></tbody>
      </table>
    </div>
  </div>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    const { createClient } = supabase;
    const db = createClient("https://omlcjvwofcdejcmybyax.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tbGNqdndvZmNkZWpjbXlieWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNzE4MjAsImV4cCI6MjA3Mjk0NzgyMH0.t00W8wIOQFMprjF8_6AvPPt2zteEs56-rI9Esw4OF_I");

    let startTime = null;
    let timerInterval = null;
    let currentUserEmail = null;
    let currentUserId = null;
    let currentUserRole = "user";
    let currentAdherenceId = null;
    let activeAdherenceTimer = null;

    const themeToggle = document.getElementById("themeToggle");
    const logoutLink = document.getElementById("logoutLink");
    const welcomeTextEl = document.getElementById("welcomeText");
    const authSection = document.getElementById("authSection");
    const appSection = document.getElementById("appSection");
    const currentUserSpan = document.getElementById("currentUser");
    const currentRoleSpan = document.getElementById("currentRole");
    const userView = document.getElementById("userView");
    const adminView = document.getElementById("adminView");

    themeToggle.addEventListener("click", (e) => {
      e.preventDefault();
      document.body.classList.toggle("dark-mode");
      themeToggle.textContent = document.body.classList.contains("dark-mode") ? "Light Mode" : "Dark Mode";
    });

    logoutLink.addEventListener("click", async (e) => {
      e.preventDefault();
      await db.auth.signOut();
      currentUserEmail = null;
      authSection.classList.remove("hidden");
      appSection.classList.add("hidden");
      logoutLink.classList.add("hidden");
      welcomeTextEl.classList.add("hidden");
      currentUserSpan.textContent = "";
      currentRoleSpan.textContent = "";
      if (activeAdherenceTimer) clearInterval(activeAdherenceTimer);
    });

    function formatDate(dateString, tzSelector = "timezoneSelect") {
      if (!dateString) return "";
      const tz =
        tzSelector === "timezoneSelect"
          ? document.getElementById(tzSelector)?.value || "Asia/Manila"
          : "Asia/Manila";
      return new Date(dateString).toLocaleString("en-US", {
        timeZone: tz,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      }).replace(/,/g, "");
    }

    function getDayRangeInTimezone(dateStr, tz) {
      const base = new Date(dateStr + "T00:00:00Z");
      const start = new Date(base.toLocaleString("en-US", { timeZone: tz }));
      start.setHours(0, 0, 0, 0);
      const end = new Date(start);
      end.setDate(end.getDate() + 1);
      return { start, end };
    }

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const { data, error } = await db.auth.signInWithPassword({ email, password });
      if (error) {
        alert("Login failed: " + error.message);
      } else {
        currentUserEmail = data.user.email;
        currentUserId = data.user.id;
        await fetchUserRole();
        showApp();
      }
    });

    document.getElementById("signupBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const { error } = await db.auth.signUp({ email, password });
      if (error) {
        alert("Signup failed: " + error.message);
      } else {
        alert("Signup successful! Please check your email to confirm.");
      }
    });

    async function fetchUserRole() {
      const { data, error } = await db.from("profiles").select("role").eq("id", currentUserId).single();
      if (!error && data) {
        currentUserRole = data.role;
      } else {
        currentUserRole = "user";
      }
    }

    function showApp() {
      authSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      currentUserSpan.textContent = currentUserEmail || "";
      currentRoleSpan.textContent = currentUserRole || "user";
      welcomeTextEl.classList.remove("hidden");
      logoutLink.classList.remove("hidden");
      if (currentUserRole === "admin") {
        adminView.classList.remove("hidden");
        userView.classList.add("hidden");
        loadAdminRecords();
      } else {
        userView.classList.remove("hidden");
        adminView.classList.add("hidden");
        loadUserRecords();
      }
    }

    function formatElapsed(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
      const seconds = String(totalSeconds % 60).padStart(2, "0");
      return `${hours}:${minutes}:${seconds}`;
    }

    // Start adherence (insert with end_time: null)
    document.getElementById('startBtn').addEventListener('click', async () => {
      startTime = new Date();
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('adherenceType').disabled = true;
      document.getElementById('adherenceTimerBox').classList.remove('hidden');
      document.getElementById('runningTime').textContent = "00:00:00";
      timerInterval = setInterval(() => {
        const now = new Date();
        document.getElementById('runningTime').textContent = formatElapsed(now - startTime);
      }, 1000);

      // Insert record with end_time: null
      const adherenceType = document.getElementById('adherenceType').value;
      const { data, error } = await db.from('adherence').insert([{
        user_id: currentUserId,
        username: currentUserEmail,
        adherence_type: adherenceType,
        start_time: startTime.toISOString(),
        end_time: null,
        duration: null
      }]).select().single();

      if (error) {
        alert("Failed to start adherence: " + error.message);
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('adherenceType').disabled = false;
        document.getElementById('adherenceTimerBox').classList.add('hidden');
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
        startTime = null;
        return;
      }
      currentAdherenceId = data.id;
    });

    // Stop adherence (update the record)
    document.getElementById('stopBtn').addEventListener('click', async () => {
      if (!startTime || !currentAdherenceId) return alert("You must start first!");
      const endTime = new Date();
      const duration = ((endTime - startTime) / 1000 / 60).toFixed(2);

      const { error } = await db.from('adherence').update({
        end_time: endTime.toISOString(),
        duration
      }).eq('id', currentAdherenceId);

      if (error) console.error(error);
      loadUserRecords();

      document.getElementById('startBtn').classList.remove('hidden');
      document.getElementById('adherenceType').disabled = false;
      document.getElementById('adherenceTimerBox').classList.add('hidden');
      document.getElementById('runningTime').textContent = "00:00:00";
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      startTime = null;
      currentAdherenceId = null;
    });

    async function loadUserRecords() {
      document.getElementById("tableBody").innerHTML = "";
      let query = db.from('adherence').select('*').eq("username", currentUserEmail).order('start_time', { ascending: false });
      const date = document.getElementById("userFilterDate").value;
      if (date) {
        const start = new Date(date);
        const end = new Date(date);
        end.setDate(end.getDate() + 1);
        query = query.gte("start_time", start.toISOString()).lt("start_time", end.toISOString());
      }
      const { data, error } = await query;
      if (!error && data) {
        data.forEach(record => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${record.username}</td>
            <td>${record.adherence_type}</td>
            <td>${formatDate(record.start_time, "user")}</td>
            <td>${formatDate(record.end_time, "user")}</td>
            <td>${record.duration}</td>
          `;
          document.getElementById('tableBody').appendChild(row);
        });
      }
    }
    document.getElementById("userFilterDate").addEventListener("change", loadUserRecords);

    async function loadActiveAdherence() {
      const tz = document.getElementById("timezoneSelect")?.value || "Asia/Manila";
      const { data, error } = await db
        .from("adherence")
        .select("*")
        .is("end_time", null);

      const tbody = document.getElementById("activeAdherenceBody");
      tbody.innerHTML = "";

      if (!error && data && data.length > 0) {
        data.forEach(record => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${record.username}</td>
            <td>${record.adherence_type}</td>
            <td>${formatDate(record.start_time, "timezoneSelect")}</td>
            <td><span class="running-timer" data-start="${record.start_time}">00:00:00</span></td>
          `;
          tbody.appendChild(tr);
        });
      } else if (tbody) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No active adherence sessions.</td></tr>`;
      }
      updateActiveTimers();
    }

    function updateActiveTimers() {
      const timers = document.querySelectorAll("#activeAdherenceBody .running-timer");
      timers.forEach(span => {
        const start = new Date(span.getAttribute("data-start"));
        const now = new Date();
        const elapsed = now - start;
        span.textContent = formatElapsed(elapsed);
      });
    }

    function startActiveAdherenceInterval() {
      if (activeAdherenceTimer) clearInterval(activeAdherenceTimer);
      activeAdherenceTimer = setInterval(updateActiveTimers, 1000);
    }

    async function loadAdminRecords() {
      document.getElementById("adminTableBody").innerHTML = "";
      let query = db.from("adherence").select("*").order("start_time", { ascending: false });
      const date = document.getElementById("filterDate").value;
      const user = document.getElementById("filterUser").value;
      const type = document.getElementById("filterType").value;
      const tz = document.getElementById("timezoneSelect").value;
      if (date) {
        const { start, end } = getDayRangeInTimezone(date, tz);
        query = query.gte("start_time", start.toISOString()).lt("start_time", end.toISOString());
      }
      if (user) query = query.ilike("username", `%${user}%`);
      if (type) query = query.eq("adherence_type", type);
      const { data, error } = await query;
      if (!error && data) {
        data.forEach(record => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${record.username}</td>
            <td>${record.adherence_type}</td>
            <td>${formatDate(record.start_time, "timezoneSelect")}</td>
            <td>${formatDate(record.end_time, "timezoneSelect")}</td>
            <td>${record.duration}</td>
          `;
          document.getElementById("adminTableBody").appendChild(row);
        });
      }
      await loadActiveAdherence();
      startActiveAdherenceInterval();
    }

    document.getElementById("filterDate").addEventListener("change", loadAdminRecords);
    document.getElementById("filterUser").addEventListener("input", loadAdminRecords);
    document.getElementById("filterType").addEventListener("change", loadAdminRecords);
    document.getElementById("timezoneSelect").addEventListener("change", () => {
      loadAdminRecords();
      loadActiveAdherence();
    });

    document.getElementById("exportCsv").addEventListener("click", async () => {
      let query = db.from("adherence").select("*").order("start_time", { ascending: false });
      const date = document.getElementById("filterDate").value;
      const user = document.getElementById("filterUser").value;
      const type = document.getElementById("filterType").value;
      const tz = document.getElementById("timezoneSelect").value;
      if (date) {
        const { start, end } = getDayRangeInTimezone(date, tz);
        query = query.gte("start_time", start.toISOString()).lt("start_time", end.toISOString());
      }
      if (user) query = query.ilike("username", `%${user}%`);
      if (type) query = query.eq("adherence_type", type);
      const { data, error } = await query;
      if (error) return alert("Error exporting CSV");
      const rows = [["User", "Adherence Type", "Start Time", "End Time", "Duration"]];
      data.forEach(record => {
        rows.push([
          record.username,
          record.adherence_type,
          formatDate(record.start_time, "timezoneSelect"),
          formatDate(record.end_time, "timezoneSelect"),
          record.duration
        ]);
      });
      const tzLabel = tz === "America/New_York" ? "EST" : tz === "America/Los_Angeles" ? "PST" : "PHT";
      const csvContent = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `adherence_records_${tzLabel}.csv`;
      link.click();
    });

    window.addEventListener("beforeunload", () => {
      if (activeAdherenceTimer) clearInterval(activeAdherenceTimer);
    });

    db.auth.getSession().then(async ({ data }) => {
      if (data.session) {
        currentUserEmail = data.session.user.email;
        currentUserId = data.session.user.id;
        await fetchUserRole();
        showApp();
      }
    });
  </script>
</body>
</html>